\section{Umsetzung der Pseudonymisierung} % und Searchable Encryption

\label{sec_impl_pseudonymity}

% Pseudonymgenerierung

% Parameter: Zeitabhängig, Häufigkeitsabhängig, USE_PFP
% Wie erfolgt die Konfiguration? Wo werden Werte gesetzt/gespeichert?

% MAC Generierung (bzw. Empfang als Search_token) beschreiben

% Zweiter MAC?
% Auch auf Vertrauensmodell im Zusammenhang mit PFP eingehen: Was erfährt die DB, was lässt sich verketten, was würde bei Aufdecken eines Pseudonyms geschehen? Was passiert bei unerlaubtem Zugriff auf gespeicherte Daten?


Für die Pseudonymisierung wurde ein Plugin für den Proxy entwickelt. Bei jedem eintreffenden Logdatum kann abhängig von dem Datenformat für ein entsprechendes Datenfeld ein Pseudonym als Ersatz für das echte Datum gesetzt werden. Dazu stellt der Pseudonym-Service eine Schnittstelle bereit, über die für ein Datum ein Pseudonym erhalten werden kann. Durch diese Trennung wird eine höhere Sicherheit der Zuordnung zwischen Datum und Pseudonym erreicht: In dem Proxy kommen die Logdaten in unveränderter Form an und werden verändert weitergesendet, daher ist die Zuordnung hier implizit bekannt und muss in Kauf genommen werden. Die Speicherung dieser Zuordnung erfolgt jedoch nur in dem Pseudonym-Service. Durch die Verschlüsselung und die in den folgenden Abschnitten beschriebene MAC-abhängige Pseudonymgenerierung erfährt der Pseudonym-Service nichts über das Datum, das durch das Pseudonym beschrieben wird. So führt unberechtigter Zugriff auf die Datenbank des Pseudonym-Service nicht zu mehr Informationen über das Datum, das ein Pseudonym bescchreibt.

Auf der Proxy-Seite wird das verschlüsselte Datum (siehe dazu Abschnitt \ref{sec_impl_threshold}) zusammen mit einem generierten MAC, der wie in Abschnitt \ref{sec_state_se} beschrieben für die Überprüfung auf bereits bestehende Pseudonyme genutzt wird, an den Pseudonym-Service gesendet. 
Der Schlüssel, der für die Generierung des MACs verwendet wird, wird immer nach einer bestimmten Zeitspanne neu generiert. Diese Zeitspanne kann mittels eines Parameters an das Anwendungsszenario angepasst werden (vgl. \ref{sec_state_pseudonymity}). Durch diesen Schlüsselwechsel wird erreicht, das für gleiche Daten, für die der MAC mit einem neuen Schlüssel erstellt wird, auch neue Pseudonyme erhalten werden. \\
Da der Schlüsselwechsel nicht Pseudonym-abhängig geschieht, ist die Zeitspanne global für alle Pseudonyme gültig und somit als maximale Zeitspanne zu verstehen. Dies kann für die Anomalieerkennung evtl. Probleme bereiten, wenn nicht genügend lange Überwachungsdaten verkettet werden können. Auf der anderen Seite würde eine Verweildauer für einzelne Pseudonyme ein Erfassen des Erstellungszeitpunkts in der Datenbank erfordern, was wie in Abschnitt \ref{sec_state_pseudonymity} beschrieben Rückschlüsse auf das ursprüngliche Datum des Pseudonyms liefern könnte. Daher wurde sich gegen diesen Ansatz entschieden.

Auf der Service-Seite wird nun anhand des empfangenen MACs durch Vergleich mit in der Datenbank vorliegenden MACs überprüft, ob bereits ein Pseudonym für das Datum vergeben wurde, das noch nicht zu häufig verwendet wurde. Ist dies noch nicht der Fall, so wird ein noch nicht verwendetes, zufälliges Pseudonym erstellt und zusammen mit dem MAC in der Datenbank gespeichert. Anderenfalls wird das bereits vergebene Pseudonym zurückgeliefert. Die maximale Anzahl an Nutzungen kann analog zur maximalen Zeitspanne ebenfalls mittels eines Parameter gesetzt werden. 

Im Zusammenspiel dieser Parameter kann jedoch noch ein Problem entstehen. Für neu vergebene Pseudonyme, die innerhalb eines Zeitabschnitts durch Überschreiten der maximalen Nutzungsanzahl entstanden sind, liegen in der Datenbank Einträge mit gleichem MAC vor. So wird die Verknüpfung verschiedener Pseudonyme ermöglicht, wenn jemand (berechtigt oder unberechtigt) Zugriff auf die Daten erhält. Das Aufdecken eines Pseudonyms deckt auch alle anderen in diesem Zeitintervall erstellten Pseudonyme implizit auf, was dem in Abschnitt \ref{sec_state_pseudonymity} beschriebenen Prinzip der \textit{Perfect Forward Privacy} widerspricht. 
Dieses Problem kann durch eine zusätzliche MAC-Berechnung auf der Service-Seite verhindert werden, die zusätzlich noch einen Pseudonym-abhängigen Zufallswert einbeziehen muss. Der hierzu verwendete Schlüssel muss dann ebenfalls abhängig von dem bereits beschriebenen Parameter neu generiert werden. Hierdurch enthalten Datenbankeinträge, die innerhalb eines Zeitintervalls zu dem gleichen Datum gehören, durch den einfließenden Zufallswert trotzdem unterschiedliche MACs und die Verkettbarkeit verschiedener Pseudonyme ist verhindert. Jedoch erfordert dieser Ansatz eine MAC-Berechnung pro Datenbankeintrag für jede Anfrage und ist daher aus Performance-Sicht kritisch zu betrachten. Daher wird diese Möglichkeit nicht implementiert. Das bestehende Problem ist jedoch für ein konkretes Anwendungsszenario und bei der Wahl der Parameter -- insbesondere des Zeitintervalls -- zu beachten.
